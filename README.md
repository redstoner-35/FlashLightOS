### 标题
` ________ ___       ________  ________  ___  ___  ___       ___  ________  ___  ___  _________        ________  ________      `
`|\  _____\\  \     |\   __  \|\   ____\|\  \|\  \|\  \     |\  \|\   ____\|\  \|\  \|\___   ___\     |\   __  \|\   ____\     `
`\ \  \__/\ \  \    \ \  \|\  \ \  \___|\ \  \\\  \ \  \    \ \  \ \  \___|\ \  \\\  \|___ \  \_|     \ \  \|\  \ \  \___|_    `
` \ \   __\\ \  \    \ \   __  \ \_____  \ \   __  \ \  \    \ \  \ \  \  __\ \   __  \   \ \  \       \ \  \\\  \ \_____  \   `
`  \ \  \_| \ \  \____\ \  \ \  \|____|\  \ \  \ \  \ \  \____\ \  \ \  \|\  \ \  \ \  \   \ \  \       \ \  \\\  \|____|\  \  `
`   \ \__\   \ \_______\ \__\ \__\____\_\  \ \__\ \__\ \_______\ \__\ \_______\ \__\ \__\   \ \__\       \ \_______\____\_\  \ `
`    \|__|    \|_______|\|__|\|__|\_________\|__|\|__|\|_______|\|__|\|_______|\|__|\|__|    \|__|        \|_______|\_________\`
`                                \|_________|                                                                      \|_________|`
                                                                                                                              
                                                                                                                                                                                                                        

powered by 35's Embedded Systems Inc. A next generation Flashlight firmware solution.                                                                                                                        

### 概述

这是由redstoner_35(from 35's Embedded Systems Inc.)开发的适用于高阶手电筒的固件系统。该系统采用裸机方式开发
并运行在合泰公司的32位HT32F52352单片机上。此系统的最大特点是采用了一套最终用户友好的console来完成固件系统的挡
位、温控曲线和固件偏好设置的可视化结果调节，而不需要像目前安德鲁之类的主流手电固件通过侧按的大量组合键来设置。
这避免了用户日常使用时意外弄乱配置的问题。同时此系统还有内置的自检和错误监控以及运行日志机制，当驱动本身检测到
自身的硬件出现异常或外部配件（例如LED本身，电池，LED温度传感器等）出现问题时，驱动将会自我保护避免损坏且将损坏
时的遥测参数存储到EEPROM中可以下载到电脑通过配套的软件进行分析。

### 硬件需求

目前此系统针对的是全程降压恒流的硬件平台，对于其他类型驱动暂未做适配。在编写此系统时我使用的是自行研发的DiffTorch
-Extreme v1.0的硬件平台（全程降压恒流+模数结合）。详细的硬件需求如下所示：

+ MCU : HT32F52352 (QFN-32或LQFP-64) 基于CM0+内核 48MHz主频(**也可以移植到同等内核的MCU上面，需要的MCU配置请参考下面的配置**)
+ EEPROM ：至少32KByte容量（工程里面提供了24C256和24C512可选）
+ 电池功率计 : 至少12bit精度,同时具有电压电流测量功能,I2C接口。工程中提供了INA219AIDCNR的驱动,您可以自行移植其他型号(例如INA226)
+ 线性调光DAC ：12-16bit精度，I2C接口，输出范围根据你的DCDC的压控电流输入来选择（工程中提供了AD5693R的驱动,但是此芯片极贵约60-70￥每片,可以自行移植）
+ LED温度传感器 ：10K额定阻值，B值3450的NTC热敏电阻。使用电阻分压方式测量（NTC电阻的基本参数可在工程中调整）
+ 功率级 ：目前支持全程降压恒流DCDC方案的功率级，**升压/线性恒流和直驱拓扑暂未适配**。需要具有输出电流/温度的电压量反馈接口和电压控制电流输入。
+ LED电压采样器 ：需要具有1/3精确比例分压和滤波功能。

#### MCU的硬件需求
+ USART : 至少1个
+ PWM Timer : 至少1个(用于月光档的PWM调光)
+ General Purpose Timer:至少2个，其中一个用于系统的8Hz心跳时钟,另一个负责给特殊挡位提供Time base
+ DMA : 至少2通道(分别处理串口的TX和RX)且具有循环地址模式和传输完成中断
+ GPIO : 至少6个GPIO
+ ADC ： 至少4通道 12bit及以上精度 具有转换完毕(EOC)中断

注意：目前工程中输出电流，温度采样的实现基于Intel DrMOS(SPS)方式实现。如果您使用不包含DrMOS的常规DCDC模块，您需要自己实现温度和电流采样算法。

### 工程结构

此工程的代码结构如下：

+ CMSIS ：包含MCU使用到的一些CMSIS库
+ Command ：包含shell后端实现各个命令处理的handler
+ ConfFileMgmt ： 实现EEPROM中配置文件的操作以及系统的自检、运行和错误日志的相关逻辑
+ Config ：包含系统的固件基本参数和硬件配置(例如IO分配等)的头文件
+ ExtPeriphal ：包含系统中一些外设（电池监视器，ADC等）的底层驱动以及顶层的代码实现（例如挡位电流调节，故障保护，侧按按键检测和指示灯控制）逻辑
+ I2C ：包含软件实现的I2C底层协议，PMBUS协议栈和一些系统中用到的I2C从设备的驱动
+ Library ：合泰单片机官方提供的外设驱动和初始化相关的库函数
+ MCUConfig ：合泰官方提供的一些MCU相关的配置，汇编文件等
+ MDK-ARM ：合泰官方提供的HT32的启动文件
+ ModeLogic ：实现系统中的挡位和开关逻辑切换以及一些特殊功能（SOS，爆闪，可编程闪，呼吸，摩尔斯发送）的逻辑
+ Shell ：系统负责调参的intractable shell的底层逻辑和顶层框架的基础实现，以及在驱动出现自检错误时的tinyshell实现
+ User ：系统主函数和一些底层库，以及一些底层需要的基础函数（例如延时，阈值表查表等）
+ Xmodem ：Xmodem协议栈的实现

### 换挡和调光逻辑

此系统使用了一套原创的，较为偏战术的换挡和调光逻辑。最大的特点是换挡和调光逻辑为两套独立的系统。这允许用户在特殊场合下
在不开启手电的情况通过侧按按钮的闪光提前选好需要的挡位然后长按直接开启手电按照设定的挡位运行。这使得一键强光/爆闪压制
之类的特殊功能可以很轻易的实现。

#### 换挡逻辑
    
系统一共有三个挡位组，每个挡位组内包含若干个挡位。通过特定次数的短按按键可以在这些挡位组内切换。这些挡位组内每个
挡位都可以使用shell任意编程功能。并不局限于出厂配置。挡位组配置如下：

+ 常规挡位组（至少1个挡位，最多8个挡位）
+ 双击功能挡位组（1个挡位，通常用于实现双击极亮功能）
+ 三击特殊功能挡位组（0-4个挡位，可以放置爆闪/SOS之类的特殊功能）

手电筒启动后默认位于常规挡位组的第1个挡位，您可以通过短按侧按按钮指定次数切换挡位组和挡位，切换的逻辑如下：

+ 位于常规挡位组：**单击**选择该组下一个挡位、**双击**切换到双击功能挡位组，**三击**切换到特殊功能挡位组。
+ 双击功能挡位组：**单击或双击**回到常规功能挡位组，**三击**切换到特殊功能挡位组。
+ 位于常规挡位组：**单击**选择该组下一个挡位、**双击**切换到双击功能挡位组，**三击**切换到常规挡位组。

#### 点亮逻辑

对于点亮逻辑和特殊模式（例如战术模式）的切换，可以参考下面的操作手册。点亮逻辑的切换可以通过对侧按进行指定次数的短按和长按
去操作。

+ 长按2秒：开启/关闭手电（如果位于战术模式，则松开按钮后手电将立即熄灭）出现错误时重置错误。
+ 单击并迅速按住按钮(持续2秒以上)：无极调光模式下调整亮度，其他模式没有作用。
+ 四击：进入和退出战术模式
+ 五击：锁定或解锁手电（锁定后即使断电也不会解除，需要再次五击方可解除）

----------------------------------------------------------------------------------------------------------------------------------
© redstoner_35 @ 35's Embedded Systems Inc.  2023